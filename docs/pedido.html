<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Seu Pedido - Parfum d'Or</title>
	<link rel="stylesheet" href="styles.css" />
	<link rel="stylesheet" href="pedido-styles.css" />
	<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Montserrat&display=swap"
		rel="stylesheet" />

</head>

<body>

	<header>
		<div class="header-texts">
			<h1>Parfum d'Or</h1>
			<p>Decantes de Luxo em cada Gota</p>
		</div>
		<a href="#" id="back-to-store" aria-label="Voltar para a loja"
			onclick="event.preventDefault(); history.back();">
			← Voltar
		</a>
	</header>

	<main class="container">
		<div id="cart-items">
			<!-- Itens do carrinho carregados via JS -->
		</div>

		<div id="cart-total"></div>

		<!-- Forma de pagamento só aparecerá via JS -->
		<div id="payment-methods" style="display:none;">
			<label>
				<input type="radio" name="payment" value="pix" required />
				PIX - 5% desconto - R$ <span id="price-with-discount">0,00</span>
			</label>
			<label>
				<input type="radio" name="payment" value="card" />
				Débito/Crédito - R$ <span id="price-with-interest">0,00</span>
			</label>
		</div>

		<button id="btn-send-order" class="btn-add">Enviar Pedido para Whatsapp</button>

		<form id="order-form" style="display: none;">
			<h3>Dados para entrega</h3>
			<label for="name">Nome Completo:</label>
			<input type="text" id="name" name="name" required />
			<label for="address">Endereço:</label>
			<input type="text" id="address" name="address" required />
			<label for="city">Cidade:</label>
			<input type="text" id="city" name="city" required />
			<label for="state">UF:</label>
			<select id="state" name="state" required>
				<option value="">Selecione</option>
				<option value="AC">AC</option>
				<option value="AL">AL</option>
				<option value="AP">AP</option>
				<option value="AM">AM</option>
				<option value="BA">BA</option>
				<option value="CE">CE</option>
				<option value="DF">DF</option>
				<option value="ES">ES</option>
				<option value="GO">GO</option>
				<option value="MA">MA</option>
				<option value="MT">MT</option>
				<option value="MS">MS</option>
				<option value="MG">MG</option>
				<option value="PA">PA</option>
				<option value="PB">PB</option>
				<option value="PR">PR</option>
				<option value="PE">PE</option>
				<option value="PI">PI</option>
				<option value="RJ">RJ</option>
				<option value="RN">RN</option>
				<option value="RS">RS</option>
				<option value="RO">RO</option>
				<option value="RR">RR</option>
				<option value="SC">SC</option>
				<option value="SP">SP</option>
				<option value="SE">SE</option>
				<option value="TO">TO</option>
			</select>
			<label for="cep">CEP:</label>
			<input type="text" id="cep" name="cep" required pattern="[0-9]{5}-?[0-9]{3}" placeholder="00000-000" />
			<button type="submit">Confirmar Pedido</button>
		</form>
	</main>

	<script>
		let cart = JSON.parse(localStorage.getItem('cart')) || [];

		const cartItemsEl = document.getElementById('cart-items');
		const cartTotalEl = document.getElementById('cart-total');
		const priceWithInterestEl = document.getElementById('price-with-interest');
		const priceWithDiscountEl = document.getElementById('price-with-discount');
		const btnSendOrder = document.getElementById('btn-send-order');
		const orderForm = document.getElementById('order-form');
		const paymentRadios = document.getElementsByName('payment');
		const paymentMethodsEl = document.getElementById('payment-methods');


		function formatPrice(value) {
			return value.toFixed(2).replace('.', ',');
		}

		function renderCartItems() {
			if (cart.length === 0) {
				// Oculta forma de pagamento, botões e formulário
				paymentMethodsEl.style.display = 'none';
				btnSendOrder.style.display = 'none';
				orderForm.style.display = 'none';
				cartTotalEl.textContent = '';
				priceWithInterestEl.textContent = '0,00';
				priceWithDiscountEl.textContent = '0,00';

				// Exibe mensagem + imagem
				cartItemsEl.innerHTML = `
                    <div class="empty-cart-msg">Sua bolsa de decantes está vazia</div>
                	<img src="./images/vazio.png"
                        alt="Bolsa vazia" class="empty-cart-img" />
                `;
				return;
			}

			paymentMethodsEl.style.display = 'flex';
			btnSendOrder.style.display = 'block';

			cartItemsEl.innerHTML = cart.map((item, index) => {
				const price =
					item.volume === '2ml' ? item.perfume.value.value2ml :
						item.volume === '5ml' ? item.perfume.value.value5ml :
							item.perfume.value.value10ml;
				return `
                    <div class="cart-item" data-index="${index}">
                        <strong>${item.perfume.name}</strong> ( ${item.volume} )<br><br>
                        Quantidade: 
                        <button class="btn-decrement" aria-label="Diminuir quantidade">-</button>
                        ${item.quantity}
                        <button class="btn-increment" aria-label="Aumentar quantidade">+</button><br><br>
                        Preço unitário: R$ ${price}<br><br>
                        <button class="btn-remove" aria-label="Remover item">Remover</button>
                    </div>`;
			}).join('');

			const total = cart.reduce((acc, item) => {
				const price =
					item.volume === '2ml' ? item.perfume.value.value2ml :
						item.volume === '5ml' ? item.perfume.value.value5ml :
							item.perfume.value.value10ml;
				return acc + price * item.quantity;
			}, 0);

			cartTotalEl.textContent = `Total: R$ ${formatPrice(total)}`;

			updatePaymentPrices();

			cartItemsEl.querySelectorAll('.btn-remove').forEach((btn, i) => {
				btn.onclick = () => {
					cart.splice(i, 1);
					saveAndRender();
				};
			});

			cartItemsEl.querySelectorAll('.btn-decrement').forEach((btn, i) => {
				btn.onclick = () => {
					if (cart[i].quantity > 1) {
						cart[i].quantity--;
					} else {
						cart.splice(i, 1);
					}
					saveAndRender();
				};
			});

			cartItemsEl.querySelectorAll('.btn-increment').forEach((btn, i) => {
				btn.onclick = () => {
					cart[i].quantity++;
					saveAndRender();
				};
			});
		}

		function saveAndRender() {
			localStorage.setItem('cart', JSON.stringify(cart));
			renderCartItems();
		}

		function updatePaymentPrices() {
			const total = cart.reduce((acc, item) => {
				const price =
					item.volume === '2ml' ? item.perfume.value.value2ml :
						item.volume === '5ml' ? item.perfume.value.value5ml :
							item.perfume.value.value10ml;
				return acc + price * item.quantity;
			}, 0);

			// Débito/Crédito = preço total
			const totalWithInterest = total;

			// PIX = 5% desconto
			const totalWithDiscount = total * 0.95;

			priceWithInterestEl.textContent = formatPrice(totalWithInterest);
			priceWithDiscountEl.textContent = formatPrice(totalWithDiscount);
		}

		btnSendOrder.addEventListener('click', () => {
			orderForm.style.display = 'block';
			btnSendOrder.style.display = 'none';
			window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
		});

		orderForm.addEventListener('submit', (e) => {
			e.preventDefault();

			const selectedPayment = Array.from(paymentRadios).find(r => r.checked);
			if (!selectedPayment) {
				alert('Por favor, selecione a forma de pagamento.');
				return;
			}

			const dataUser = {
				nome: orderForm.name.value.trim(),
				endereco: orderForm.address.value.trim(),
				cidade: orderForm.city.value.trim(),
				uf: orderForm.state.value,
				cep: orderForm.cep.value.trim(),
				pagamento: selectedPayment.value,
				pedido: cart
			};

			let orderMessage = `*Parfum d'Or*\n\n`;
			orderMessage += `Nome: ${dataUser.nome}\n`;
			orderMessage += `Endereço: ${dataUser.endereco}, ${dataUser.cidade} - ${dataUser.uf}, ${dataUser.cep}\n\n`;
			orderMessage += `Forma de Pagamento: ${dataUser.pagamento === 'pix' ? 'PIX (-5%)' : 'Débito/Crédito'}\n\n`;
			orderMessage += `*Itens no Pedido:*\n`;

			dataUser.pedido.forEach(item => {
				const price =
					item.volume === '2ml' ? item.perfume.value.value2ml :
						item.volume === '5ml' ? item.perfume.value.value5ml :
							item.perfume.value.value10ml;
				orderMessage += `${item.perfume.name} (${item.volume}) - R$ ${price} x ${item.quantity} = R$ ${price * item.quantity}\n`;
			});

			const totalBase = dataUser.pedido.reduce((acc, item) => {
				const price =
					item.volume === '2ml' ? item.perfume.value.value2ml :
						item.volume === '5ml' ? item.perfume.value.value5ml :
							item.perfume.value.value10ml;
				return acc + price * item.quantity;
			}, 0);

			const totalFinal = dataUser.pagamento === 'pix' ? totalBase * 0.95 : totalBase;

			orderMessage += `\nTotal: R$ ${formatPrice(totalFinal)}\n\n`;
			orderMessage += `Por favor ${dataUser.nome}, confirme os dados, estaremos respondendo seu pedido.`;

			const whatsappURL = `https://wa.me/558799706139?text=${encodeURIComponent(orderMessage)}`;
			window.open(whatsappURL, '_blank');

			cart = [];
			localStorage.removeItem('cart');
			renderCartItems();
			orderForm.reset();
			orderForm.style.display = 'none';
			btnSendOrder.style.display = 'block';
		});

		renderCartItems();
	</script>

</body>

</html>